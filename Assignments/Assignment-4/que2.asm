CPU "8085.TBL"
HOF "INT8"

HXDSP: EQU 034FH
OUTPUT: EQU 0389H
GTHEX: EQU 030EH
RDKBD: EQU 03BAH
MEM: EQU 09000H

ORG 9C00H
MVI A,8BH
OUT 43H

MVI A,80H
OUT 03H

LXI H,MEM
MVI M,000H

LOOP:
	MVI A,000H
	CALL GTHEX
	MOV A,E

	CPI 001H
	JZ ADD
	
	CPI 002H
	JZ SUBT
	
	CPI 003H
	JZ AVG
	JMP LOOP

ADD:
	MVI D,000H
	MVI E,000H
	CALL CONVERT
	LXI H,MEM
	MVI M,000H
	MOV M,A

	MVI D,004H
	MVI E,000H
	CALL CONVERT
	LXI H,MEM
	MOV B,M
	ADD B

    MOV E,A
    MVI D,000H
    JNC CARR
    INR D
    CARR:
    MOV A,E
    OUT 00H
    OUT 01H
    CALL HXDSP
    mvi a, 00H
    mvi b, 00H
    CALL OUTPUT	
    JMP LOOP

SUBT:
	MVI D,000H
	MVI E,000H
	CALL CONVERT
	LXI H,MEM
	MVI M,000H
	MOV M,A

	MVI D,004H
	MVI E,000H
	CALL CONVERT
	LXI H,MEM
	MOV B,M
	SUB B

	MOV E,A
    MVI D,000H
    
    MOV A,E
    OUT 00H
    OUT 01H
    CALL HXDSP
    mvi a, 00H
    mvi b, 00H
    CALL OUTPUT	
    JMP LOOP

AVG:
    LXI H,MEM
    MVI M,000H

    MVI C,00AH
    RE_LOOP:
    	CALL RDKBD
    	MVI D,000H
    	MVI E,000H
    	CALL CONVERT
    	MOV B,M
    	ADD B
    	MOV M,A

    	MVI D,000H
    	MVI E,000H
    	CALL CONVERT
    	MOV B,M
    	ADD B
    	MOV M,A
    	DCR C
    	MVI A,000H
    	CMP C
    	JNZ RE_LOOP
    
    MOV A,M
	MVI B, 14H
	MOV C, 000H
	DIV:
		SUB B
		JC DIV_EXIT
		INR C
		JMP DIV
	DIV_EXIT:
		MOV E,C
	    MOV A,E
	    OUT 00H
	    OUT 01H
		CALL HXDSP
	    mvi a, 00H
	    mvi b, 00H
	    CALL OUTPUT	
    JMP LOOP

CONVERT:
	MVI A,000H
	ORA D
	OUT 40H
	MVI A,020H
	ORA D
	OUT 40H
	NOP
	NOP
	MVI A,000H
	ORA D
	OUT 40H

WAIT1:
	IN 42H
	ANI 001H
	JNZ WAIT1

WAIT2:
	IN 42H
	ANI 001H
	JZ WAIT2
	MVI A,040H
	ORA D
	OUT 40H
	OUT 40H
	NOP
	IN 41H
	PUSH PSW
	MVI A,000H
	ORA D
	OUT 40H
	POP PSW
	RET

